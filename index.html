<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Cuestionario Manipulaci√≥n de Alimentos ‚Äì 3 Bloques (25 c/u)</title>
<meta content="light dark" name="color-scheme"/>
<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --ink:#e6ecff; --muted:#9fb0d0; --brand:#6ee7b7;
    --accent:#60a5fa; --ok:#34d399; --bad:#f87171; --warn:#fbbf24; --line:#1f2a44;
    --chip:#19243a; --choice:#162238; --choice-h:#1c2b47; --explain:#0f1a2e;
    --btn:#1f2a44; --btn-h:#233152; --shadow: 0 12px 30px rgba(0,0,0,.35);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0b1220; --muted:#55627a; --brand:#0ea5e9;
      --accent:#2563eb; --ok:#059669; --bad:#dc2626; --warn:#b45309; --line:#e6ebf2;
      --chip:#eef2ff; --choice:#f8fafc; --choice-h:#eef2f9; --explain:#f3f6ff;
      --btn:#0f172a; --btn-h:#111827; --shadow: 0 12px 30px rgba(2,6,23,.08);
    }
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,var(--bg),#0d1629 35%,var(--bg));color:var(--ink)}
  .wrap{max-width:980px;margin:auto;padding:clamp(16px,3vw,28px)}
  .card{background:var(--card); border:1px solid var(--line); border-radius:18px; padding:clamp(16px,2.5vw,28px); box-shadow:var(--shadow)}
  h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted); margin:0 0 18px}
  .row{display:flex; gap:14px; flex-wrap:wrap}
  .chip{background:var(--chip); color:var(--accent); border:1px solid var(--line); padding:8px 12px; border-radius:999px; font-weight:700}
  .muted{color:var(--muted)}
  .block-picker{display:grid;grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px; margin:18px 0 6px}
  .block{border:1px solid var(--line); background:var(--choice); border-radius:16px; padding:18px; cursor:pointer; transition:transform .12s ease, background .12s; position:relative}
  .block:hover{transform:translateY(-2px); background:var(--choice-h)}
  .tag{font-size:12px; letter-spacing:.4px; text-transform:uppercase; color:var(--muted)}
  .lv{font-weight:800; font-size:20px; margin:6px 0 2px}
  .desc{color:var(--muted); font-size:14px}
  .go{display:inline-flex; align-items:center; gap:8px; margin-top:12px; padding:10px 14px; border-radius:12px; background:var(--btn); color:#fff; text-decoration:none; border:1px solid var(--line)}
  .go:hover{background:var(--btn-h)}
  .progress{height:8px; background:var(--chip); border:1px solid var(--line); border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--accent))}
  .qhead{display:flex; justify-content:space-between; align-items:center; gap:16px}
  .qtitle{font-weight:800; font-size:18px; line-height:1.4}
  .idx{font-variant-numeric:tabular-nums; color:var(--muted); font-weight:700}
  .choices{display:grid; gap:10px; margin-top:14px}
  .choice{border:1px solid var(--line); background:var(--choice); border-radius:12px; padding:14px; cursor:pointer; display:flex; gap:10px; align-items:flex-start; transition:background .12s}
  .choice:hover{background:var(--choice-h)}
  .bullet{width:22px; height:22px; border:2px solid var(--muted); border-radius:999px; flex:0 0 22px; transform:translateY(2px)}
  .choice.selected .bullet{border-color:var(--accent); box-shadow:0 0 0 4px color-mix(in oklab,var(--accent) 25%, transparent)}
  .choice.correct{border-color:color-mix(in oklab,var(--ok) 60%, var(--line)); box-shadow:0 0 0 2px color-mix(in oklab,var(--ok) 18%, transparent)}
  .choice.incorrect{border-color:color-mix(in oklab,var(--bad) 60%, var(--line)); box-shadow:0 0 0 2px color-mix(in oklab,var(--bad) 18%, transparent)}
  .explain{margin-top:14px; background:var(--explain); border:1px solid var(--line); border-radius:12px; padding:14px}
  .explain b{color:var(--brand)}
  .footer{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:18px}
  .btn{background:var(--btn); color:#fff; border:1px solid var(--line); border-radius:12px; padding:12px 16px; cursor:pointer; font-weight:700}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .score{font-weight:800}
  .summary{display:grid; gap:10px; margin-top:10px}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:var(--chip)}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .hint{font-size:13px; color:var(--muted)}
  .small{font-size:14px}
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  .hidden{display:none!important}

  .brand-logos{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;align-items:center;margin:6px 0 12px}
  .brand-logos .logo-card{background:var(--choice);border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;justify-content:center;align-items:center}
  .brand-logos img{max-width:100%;height:auto;object-fit:contain}
  @media (max-width:720px){.brand-logos{grid-template-columns:1fr}}
  .mission{margin:10px 0 0;background:var(--chip);border:1px solid var(--line);border-radius:14px;padding:14px}
  .mission h3{margin:0 0 6px;font-size:16px}
  .mission p{margin:6px 0;color:var(--muted)}
  .mission ul{margin:8px 0 0 18px}
  .mission li{margin:4px 0}

  .start-form{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0 6px}
  .start-form input[type="text"]{border:1px solid var(--line);background:var(--choice);color:var(--ink);
    border-radius:10px;padding:10px 12px;outline:none}
  .start-actions{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .btn.secondary{background:transparent;color:var(--ink)}
  .btn.secondary{border:1px solid var(--line)}
  .leaderboard{margin-top:10px}
  .table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left}
  .table th{background:var(--chip);color:var(--muted);font-weight:700}
  .table tr:last-child td{border-bottom:none}
  .rank1{font-weight:800}
  .rank2{font-weight:700}
  .rank3{font-weight:700}
  .save-rank{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .save-rank input[type="text"]{border:1px solid var(--line);background:var(--choice);color:var(--ink);
    border-radius:10px;padding:10px 12px;outline:none}
  .notice{font-size:12px;color:var(--muted)}

  .banner{margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); display:flex; gap:10px; align-items:flex-start}
  .banner.ok{background:color-mix(in oklab, var(--ok) 12%, transparent); border-color:color-mix(in oklab,var(--ok) 40%, var(--line)); color:var(--ink)}
  .banner.bad{background:color-mix(in oklab, var(--bad) 12%, transparent); border-color:color-mix(in oklab,var(--bad) 40%, var(--line)); color:var(--ink)}
  .choice.correct::after{content:" ‚úÖ"; font-weight:700; margin-left:auto}
  .choice.incorrect::after{content:" ‚ùå"; font-weight:700; margin-left:auto}
  .review{margin-top:14px}
  .review h3{margin:0 0 8px}
  .review-item{border:1px solid var(--line); border-radius:12px; padding:12px; background:var(--choice); margin-bottom:10px}
  .review-item .q{font-weight:700; margin-bottom:6px}
  .review-item .u{margin:2px 0; color:var(--bad)}
  .review-item .c{margin:2px 0; color:var(--ok)}
  .advice{margin-top:12px; background:var(--chip); border:1px solid var(--line); border-radius:12px; padding:12px}
  .advice ul{margin:6px 0 0 18px}
  .advice li{margin:4px 0}
</style>
</head>
<body>
<div class="wrap">
<div class="card" id="screen-start">
<h1>Cuestionario ‚Äî Manipulaci√≥n de Alimentos</h1>
<p class="sub">Elige bloque. <span class="hint">1 = f√°cil ¬∑ 2 = medio ¬∑ 3 = dif√≠cil.</span></p><div class="brand-logos"><div class="logo-card"><img alt="Hotel Guadiana by Sercotel ‚Äî Logo" src="img/guadiana-logo.jpg"/></div><div class="logo-card"><img alt="Cumbria Hotel y Centro de Empresas ‚Äî Logo" src="img/cumbria-logo.jpg"/></div></div><div class="mission"><h3>¬øPor qu√© realizamos este cuestionario en nuestros hoteles?</h3><p>Porque la seguridad alimentaria es esencial para nuestros hu√©spedes y para el equipo. Este ejercicio ayuda a reforzar conocimientos cr√≠ticos y a unificar criterios de trabajo.</p><ul><li>Prevenir intoxicaciones y alergias alimentarias (control de al√©rgenos, anisakis, temperaturas).</li><li>Cumplir la normativa vigente y los est√°ndares de calidad a los que aspiramos.</li><li>Mejorar la experiencia del cliente asegurando alimentos seguros en todo momento.</li><li>Reducir mermas y reprocesos mediante buenas pr√°cticas (FIFO/FEFO, limpieza y desinfecci√≥n).</li><li>Fortalecer la cultura de seguridad alimentaria en todos los turnos y departamentos.</li></ul></div><div class="start-form"><input id="player-name" placeholder="Tu nombre para el ranking (opcional)" type="text"/><button class="btn" id="btn-save-name" type="button">Guardar nombre</button></div><div class="start-actions"><button class="btn secondary" id="btn-view-lb" type="button">Ver ranking</button><button class="btn secondary" id="btn-clear-lb" type="button">Borrar mi puntuaci√≥n</button></div>
<div class="block-picker" id="picker">
<!-- Se generan por JS -->
</div>
<p class="muted small">Recomendaci√≥n: completar los 3 bloques. No se puede retroceder entre preguntas.</p>
</div>
<div class="card hidden" id="screen-quiz">
<div class="row" style="justify-content:space-between; align-items:center; margin-bottom:10px">
<div class="chip" id="chip-level">Bloque 1 ¬∑ F√°cil</div>
<div class="pill"><span class="score" id="score-mini">0</span>/<span id="total-mini">0</span> correctas</div>
</div>
<div aria-label="Progreso" class="progress"><div class="bar" id="bar"></div></div>
<div style="margin-top:16px">
<div class="qhead">
<div class="idx" id="q-idx">Pregunta 1</div>
<div class="idx" id="q-count">/ 25</div>
</div>
<div class="qtitle" id="q-title">...</div>
<div class="choices" id="choices"></div>
<div class="explain hidden" id="explain"></div>
<div class="footer">
<div class="muted hint">Tras responder, ver√°s la explicaci√≥n de la correcta.</div>
<button class="btn" disabled="" id="btn-next">Siguiente</button>
</div>
</div>
</div>
<div class="card hidden" id="screen-end">
<h2 style="margin:0 0 6px">¬°Bloque completado!</h2>
<p class="sub" id="end-sub">Resultados del bloque‚Ä¶</p>
<div class="summary" id="end-summary"></div>
<div class="row" style="margin-top:12px">
<button class="btn" id="btn-next-block">Siguiente bloque</button>
<button class="btn" id="btn-restart">Volver a empezar</button>
</div>
<p class="hint" style="margin-top:10px">Puedes a√±adir/editar preguntas en el array <b>blocks</b> dentro del c√≥digo. Soporta 25+ por bloque.</p>
<div class="save-rank"><span>Guardar en ranking:</span><input id="rank-name" placeholder="Tu nombre" type="text"/><button class="btn" id="btn-save-rank" type="button">Guardar puntuaci√≥n</button><div class="notice">Se guardan: nombre, bloque, puntuaci√≥n y fecha. Local en tu navegador.</div></div><div class="review" id="end-review"><h3>Preguntas a revisar</h3><div id="review-list"></div></div><div class="advice" id="end-advice"><h3>Recomendaci√≥n personalizada</h3><div id="advice-body"></div></div></div>
<div class="card hidden" id="screen-lb"><h2>Ranking de participantes</h2><p class="sub">Top 20 por porcentaje, mostrando √∫ltimo intento por persona.</p><div class="leaderboard" id="leaderboard"></div><button class="btn" id="btn-back-start" type="button">Volver</button></div></div>
<script>
const blocks = [
  {
    "id": 1,
    "level": "F√°cil",
    "color": "üü¢",
    "questions": [
      {
        "q": "¬øQu√© es la contaminaci√≥n cruzada?",
        "options": [
          "Cuando un alimento pierde sabor por el fr√≠o.",
          "La transferencia de microorganismos o al√©rgenos entre alimentos por contacto directo o indirecto.",
          "La mezcla voluntaria de dos alimentos compatibles."
        ],
        "correctIndex": 1,
        "rationale": "Puede producirse por manos, utensilios, pa√±os o superficies; separa crudos de listos para consumo."
      },
      {
        "q": "Temperatura correcta de refrigeraci√≥n para alimentos frescos en general:",
        "options": [
          "0‚Äì4 ¬∞C",
          "10‚Äì14 ¬∞C",
          "‚Äì5‚Äì0 ¬∞C"
        ],
        "correctIndex": 0,
        "rationale": "La proliferaci√≥n microbiana se ralentiza a 0‚Äì4 ¬∞C; vigila con term√≥metro."
      },
      {
        "q": "¬øSe pueden descongelar alimentos a temperatura ambiente?",
        "options": [
          "S√≠, si se cocinan luego.",
          "No, deben descongelarse en nevera o microondas.",
          "S√≠, si se cubren con film."
        ],
        "correctIndex": 1,
        "rationale": "La descongelaci√≥n a temperatura ambiente favorece el crecimiento microbiano superficial."
      },
      {
        "q": "Temperatura m√≠nima en el centro del producto para una cocci√≥n segura general:",
        "options": [
          "55 ¬∞C",
          "70 ¬∞C",
          "90 ¬∞C"
        ],
        "correctIndex": 1,
        "rationale": "70 ¬∞C en el centro es referencia de seguridad; huevo fresco en tortilla requiere 75 ¬∞C."
      },
      {
        "q": "Uso de guantes:",
        "options": [
          "Sustituyen el lavado de manos.",
          "No eximen del lavado y deben cambiarse con frecuencia.",
          "Pueden usarse todo el d√≠a."
        ],
        "correctIndex": 1,
        "rationale": "Los guantes no sustituyen la higiene de manos; c√°mbialos al cambiar de tarea."
      },
      {
        "q": "Orden en frigor√≠fico √∫nico para evitar contaminaci√≥n cruzada:",
        "options": [
          "Crudos arriba y cocinados abajo.",
          "Cocinados arriba y crudos abajo.",
          "Todo mezclado si est√° tapado."
        ],
        "correctIndex": 1,
        "rationale": "Coloca cocinados arriba para evitar goteos de crudos sobre alimentos listos para consumo."
      },
      {
        "q": "Mantenimiento en caliente antes del servicio (m√≠nimo en el centro del alimento):",
        "options": [
          "45 ¬∞C",
          "65 ¬∞C",
          "80 ¬∞C"
        ],
        "correctIndex": 1,
        "rationale": "Mantener a ‚â•65 ¬∞C reduce el riesgo de crecimiento microbiano."
      },
      {
        "q": "¬øCu√°ndo debes lavarte las manos?",
        "options": [
          "Solo al empezar el turno.",
          "Antes de manipular alimentos y tras tocar crudos, basura, m√≥vil, toser, ir al ba√±o, etc.",
          "Cada hora."
        ],
        "correctIndex": 1,
        "rationale": "Siempre que se cambie de tarea o haya posibilidad de contaminaci√≥n."
      },
      {
        "q": "¬øSe pueden volver a congelar alimentos ya descongelados?",
        "options": [
          "S√≠, siempre.",
          "No, nunca.",
          "Solo si no han perdido el vac√≠o."
        ],
        "correctIndex": 1,
        "rationale": "No recongelar: aumenta el riesgo de proliferaci√≥n y deterioro."
      },
      {
        "q": "¬øQu√© no debes hacer al manipular alimentos?",
        "options": [
          "Usar pa√±os de cocina para m√∫ltiples tareas.",
          "Probar con cuchara limpia y lavarla despu√©s.",
          "Usar utensilios para tocar alimentos listos."
        ],
        "correctIndex": 0,
        "rationale": "Evita pa√±os reutilizados; mejor papel desechable y pa√±os diferenciados."
      },
      {
        "q": "Lavado de frutas/verduras crudas:",
        "options": [
          "No es necesario si se ven limpias.",
          "Lavar enteras bajo el grifo y desinfectar seg√∫n protocolo.",
          "Cortar primero y luego lavar."
        ],
        "correctIndex": 1,
        "rationale": "Lavar la pieza entera primero evita que la suciedad entre en el interior."
      },
      {
        "q": "Para reducir anisakis en pescado crudo/marinado:",
        "options": [
          "Solo lavarlo con agua fr√≠a.",
          "Congelar a ‚Äì20 ¬∞C ‚â•24 h antes del servicio.",
          "Cocinarlos a 50 ¬∞C."
        ],
        "correctIndex": 1,
        "rationale": "La congelaci√≥n a ‚Äì20 ¬∞C durante al menos 24 h inactiva anisakis."
      },
      {
        "q": "Conservaci√≥n de platos elaborados para >24 h:",
        "options": [
          "0‚Äì4 ¬∞C",
          "0‚Äì8 ¬∞C",
          "5‚Äì8 ¬∞C"
        ],
        "correctIndex": 0,
        "rationale": "Para duraciones largas, 0‚Äì4 ¬∞C; si <24 h, hasta 8 ¬∞C."
      },
      {
        "q": "Gesti√≥n de residuos:",
        "options": [
          "Abrir contenedores con pedal y limpiarlos a diario.",
          "Vaciar solo al 100% y abrir con la mano.",
          "Verter aceite usado por el fregadero."
        ],
        "correctIndex": 0,
        "rationale": "Evita contacto manual y vierte aceites en gestores autorizados."
      },
      {
        "q": "Higiene personal correcta:",
        "options": [
          "Usar joyas si est√°n limpias.",
          "U√±as cortas, sin esmalte; cabello recogido y cubierto.",
          "Perfume intenso para tapar olores."
        ],
        "correctIndex": 1,
        "rationale": "Las joyas y esmaltes pueden desprenderse/contaminar; el cabello debe estar controlado."
      },
      {
        "q": "Equipamiento de corte (tablas y cuchillos):",
        "options": [
          "Usar la misma tabla para todo.",
          "Diferenciar por c√≥digo de color o uso.",
          "Solo importa que est√©n afilados."
        ],
        "correctIndex": 1,
        "rationale": "Separar tablas por uso reduce contaminaci√≥n cruzada."
      },
      {
        "q": "Limpieza de superficies:",
        "options": [
          "Primero desinfectar y luego limpiar.",
          "Primero limpiar con detergente, despu√©s desinfectar.",
          "Solo agua caliente."
        ],
        "correctIndex": 1,
        "rationale": "La materia org√°nica inactiva desinfectantes; limpia antes de desinfectar."
      },
      {
        "q": "Cadena de fr√≠o en recepci√≥n:",
        "options": [
          "No es importante si el transporte fue corto.",
          "Registrar temperaturas y almacenar de inmediato.",
          "Esperar a terminar otras tareas."
        ],
        "correctIndex": 1,
        "rationale": "Las temperaturas deben verificarse y los productos entrar a c√°mara sin demora."
      },
      {
        "q": "Fecha de caducidad vs. consumo preferente:",
        "options": [
          "Son lo mismo.",
          "Caducidad: seguridad; Preferente: calidad.",
          "Preferente es m√°s estricta que caducidad."
        ],
        "correctIndex": 1,
        "rationale": "La caducidad implica riesgo sanitario tras la fecha; consumo preferente afecta cualidades organol√©pticas."
      },
      {
        "q": "Descongelaci√≥n segura de grandes piezas:",
        "options": [
          "En nevera, sobre rejilla, recipientes que recojan goteos.",
          "A temperatura ambiente sobre la mesa.",
          "Bajo agua caliente."
        ],
        "correctIndex": 0,
        "rationale": "Evita goteos y superficies a temperatura de peligro."
      },
      {
        "q": "Toma de temperatura del alimento:",
        "options": [
          "Cualquier zona sirve.",
          "En el centro del producto y zonas m√°s gruesas.",
          "En la superficie."
        ],
        "correctIndex": 1,
        "rationale": "El punto m√°s fr√≠o suele ser el centro; verifica all√≠."
      },
      {
        "q": "Uso del m√≥vil en cocina:",
        "options": [
          "Permitido si es r√°pido.",
          "Evitarlo; si se usa, lavar manos despu√©s.",
          "No influye."
        ],
        "correctIndex": 1,
        "rationale": "El m√≥vil es un vector de contaminaci√≥n; higiene posterior obligatoria."
      },
      {
        "q": "Desinfecci√≥n de hojas verde-lamela:",
        "options": [
          "Jab√≥n suave.",
          "Agua con desinfectante alimentario seg√∫n etiqueta.",
          "Vinagre casero siempre."
        ],
        "correctIndex": 1,
        "rationale": "Usa productos autorizados y respeta tiempos/concentraciones."
      },
      {
        "q": "Manipulaci√≥n de hielo para bebidas:",
        "options": [
          "Con las manos limpias.",
          "Con pinzas o cubitera y utensilios limpios.",
          "Cualquier m√©todo sirve."
        ],
        "correctIndex": 1,
        "rationale": "El hielo es alimento; manip√∫lalo con utensilios limpios para evitar contaminaci√≥n."
      },
      {
        "q": "Al√©rgenos:",
        "options": [
          "Basta con avisar verbalmente.",
          "Debes conocer y poder informar por escrito de los al√©rgenos presentes.",
          "No es obligatorio informar."
        ],
        "correctIndex": 1,
        "rationale": "La informaci√≥n de al√©rgenos debe ser clara, accesible y fiable para el cliente."
      }
    ]
  },
  {
    "id": 2,
    "level": "Medio",
    "color": "üü°",
    "questions": [
      {
        "q": "Zona de peligro de temperaturas para crecimiento microbiano (aprox.):",
        "options": [
          "10‚Äì64 ¬∞C",
          "‚Äì18‚Äì0 ¬∞C",
          "65‚Äì90 ¬∞C"
        ],
        "correctIndex": 0,
        "rationale": "Evita mantener alimentos en ese rango durante tiempos prolongados."
      },
      {
        "q": "Huevos en elaboraciones (p. ej., tortillas): temperatura de seguridad en el centro:",
        "options": [
          "60 ¬∞C",
          "70 ¬∞C",
          "75 ¬∞C"
        ],
        "correctIndex": 2,
        "rationale": "Para huevo fresco en tortilla se recomienda alcanzar 75 ¬∞C en centro."
      },
      {
        "q": "Recepci√≥n de congelados:",
        "options": [
          "‚Äì18 ¬∞C (¬±3 ¬∞C) y envases √≠ntegros.",
          "0‚Äì4 ¬∞C y envases abiertos.",
          "Cualquier temperatura si se ven duros."
        ],
        "correctIndex": 0,
        "rationale": "Comprueba temperatura y estado del envase; rechazo si no cumple."
      },
      {
        "q": "Verduras para consumo en crudo:",
        "options": [
          "Cortar primero y luego lavar.",
          "Lavar enteras, desinfectar y enjuagar.",
          "No requieren desinfecci√≥n."
        ],
        "correctIndex": 1,
        "rationale": "Lavar enteras evita arrastrar suciedad al interior."
      },
      {
        "q": "Aceites de fritura: cu√°ndo renovar:",
        "options": [
          "Con humo, viscosidad, oscurecimiento o espuma.",
          "Una vez por semana siempre.",
          "Solo si cambia el sabor."
        ],
        "correctIndex": 0,
        "rationale": "Esos signos indican degradaci√≥n y compuestos indeseables."
      },
      {
        "q": "Alergia vs. intolerancia:",
        "options": [
          "Ambas son inmunitarias.",
          "La intolerancia es siempre m√°s grave.",
          "Alergia es inmunitaria; intolerancia es dificultad de digesti√≥n/metabolismo."
        ],
        "correctIndex": 2,
        "rationale": "Diferenciar ambas para informar y etiquetar correctamente."
      },
      {
        "q": "Anisakis en pescado a consumir crudo/marinado:",
        "options": [
          "Congelar a ‚Äì20 ¬∞C ‚â•24 h.",
          "Solo lavar con agua fr√≠a.",
          "No requiere nada si es del d√≠a."
        ],
        "correctIndex": 0,
        "rationale": "La congelaci√≥n preventiva es obligada salvo exenciones espec√≠ficas."
      },
      {
        "q": "Mantenimiento en fr√≠o de elaboraciones >24 h:",
        "options": [
          "0‚Äì4 ¬∞C",
          "0‚Äì8 ¬∞C",
          "5‚Äì8 ¬∞C"
        ],
        "correctIndex": 0,
        "rationale": "Para periodos largos, m√°ximo 4 ¬∞C."
      },
      {
        "q": "Gesti√≥n de residuos correcta:",
        "options": [
          "Tapa con pedal, limpieza y vaciado frecuente.",
          "Abrir con la mano y vaciar al 100%.",
          "Aceite por el desag√ºe con agua caliente."
        ],
        "correctIndex": 0,
        "rationale": "Evita vectores y atascos; gestor autorizado para aceites."
      },
      {
        "q": "Envasado al vac√≠o tras elaboraci√≥n:",
        "options": [
          "Conservar a ‚â§4 ¬∞C e identificar con fecha y lote.",
          "Puede ir a ambiente si el cierre es bueno.",
          "Reutilizar envases qu√≠micos si se lavan."
        ],
        "correctIndex": 0,
        "rationale": "El vac√≠o no sustituye el fr√≠o; trazabilidad imprescindible."
      },
      {
        "q": "Plan de limpieza y desinfecci√≥n (PLD):",
        "options": [
          "Improvisar seg√∫n suciedad.",
          "Debe estar documentado con qu√©, c√≥mo, cu√°ndo y qui√©n.",
          "Solo limpiar cuando venga inspecci√≥n."
        ],
        "correctIndex": 1,
        "rationale": "Procedimientos escritos y registros garantizan control higi√©nico."
      },
      {
        "q": "Control de plagas (DDD):",
        "options": [
          "Dejar residuos de comida para atraer cebo.",
          "Mantener orden/limpieza y contratar servicio autorizado con registros.",
          "Solo usar insecticida dom√©stico."
        ],
        "correctIndex": 1,
        "rationale": "Prevenci√≥n + monitoreo profesional con trazabilidad."
      },
      {
        "q": "Trazabilidad:",
        "options": [
          "Conservar albaranes/etiquetas y poder rastrear lotes.",
          "No es necesaria si compro a diario.",
          "Solo aplica a carne y pescado."
        ],
        "correctIndex": 0,
        "rationale": "Permite identificar y retirar productos en caso de alerta."
      },
      {
        "q": "Enfriamiento r√°pido de platos cocinados:",
        "options": [
          "De caliente a ‚â§8 ¬∞C en <2 h; usar abatidor o porcionar.",
          "Esperar a que se temple a ambiente.",
          "Tapar caliente y a c√°mara inmediatamente."
        ],
        "correctIndex": 0,
        "rationale": "Cruzar la zona de peligro lo m√°s r√°pido posible."
      },
      {
        "q": "Almacenamiento en seco (despensa):",
        "options": [
          "10‚Äì21 ¬∞C, seco, limpio y ventilado; rotaci√≥n FIFO/FEFO.",
          "Cualquier temperatura si est√° cerrado.",
          "Junto a productos qu√≠micos si est√°n precintados."
        ],
        "correctIndex": 0,
        "rationale": "Control ambiental y separaci√≥n de qu√≠micos es esencial."
      },
      {
        "q": "Manipulador con s√≠ntomas gastrointestinales:",
        "options": [
          "Puede trabajar en sala.",
          "Debe comunicar y abandonar tareas de alimentos; valoraci√≥n m√©dica.",
          "Solo usar doble guante."
        ],
        "correctIndex": 1,
        "rationale": "Evitar el riesgo de transmisi√≥n por manos o got√≠culas."
      },
      {
        "q": "Uso de pa√±os:",
        "options": [
          "Reutilizar continuamente.",
          "Pa√±os diferenciados por uso o, mejor, papel desechable.",
          "Cualquiera sirve."
        ],
        "correctIndex": 1,
        "rationale": "Reduce contaminaci√≥n cruzada entre zonas/tareas."
      },
      {
        "q": "Descongelaci√≥n en microondas:",
        "options": [
          "Permitida, seguido de cocci√≥n inmediata.",
          "Prohibida.",
          "Solo para pan."
        ],
        "correctIndex": 0,
        "rationale": "Descongelar y cocinar sin demora evita proliferaci√≥n."
      },
      {
        "q": "Huevos con c√°scara sucia o rota:",
        "options": [
          "Usarlos si se lavan bien.",
          "No deben usarse en cocina; riesgo de contaminaci√≥n.",
          "Solo para bizcochos."
        ],
        "correctIndex": 1,
        "rationale": "La c√°scara da√±ada facilita entrada de microorganismos."
      },
      {
        "q": "Cuchillos y tablas tras tocar crudo:",
        "options": [
          "Seguir con listo para consumo.",
          "Lavar y desinfectar antes de cambiar de alimento.",
          "Limpiar con servilleta."
        ],
        "correctIndex": 1,
        "rationale": "Evita transferencia de pat√≥genos a alimentos listos."
      },
      {
        "q": "Mantenimiento en caliente en autoservicio/buffet:",
        "options": [
          "‚â•65 ¬∞C y control frecuente.",
          "50‚Äì60 ¬∞C suficientes.",
          "Cualquier temperatura si hay tapa."
        ],
        "correctIndex": 0,
        "rationale": "La l√≠nea caliente exige control para evitar zona de peligro."
      },
      {
        "q": "Recalentamiento de platos preparados:",
        "options": [
          "Alcanzar 70 ¬∞C en el centro en corto tiempo con equipo adecuado.",
          "Al ba√±o mar√≠a lento hasta templado.",
          "Solo que humee."
        ],
        "correctIndex": 0,
        "rationale": "Recalentar r√°pido hasta temperatura segura; no usar equipos lentos para elevar temperatura."
      },
      {
        "q": "Hielo almacenado junto a pescado crudo:",
        "options": [
          "Admite contacto directo.",
          "Separar y manipular con utensilios distintos.",
          "No importa si el hielo se ve limpio."
        ],
        "correctIndex": 1,
        "rationale": "Evita contaminaci√≥n por goteos y contacto crudo-listo."
      },
      {
        "q": "Etiquetado interno de elaboraciones:",
        "options": [
          "Fecha de elaboraci√≥n, caducidad/consumo, lote y responsable.",
          "No hace falta si es para hoy.",
          "Solo el nombre del plato."
        ],
        "correctIndex": 0,
        "rationale": "Facilita control de rotaci√≥n, trazabilidad y responsabilidades."
      },
      {
        "q": "Agua no potable por aver√≠a:",
        "options": [
          "Seguir operando igual.",
          "Suspender preparaciones que requieran agua potable y usar agua segura embotellada; informar.",
          "Hervir 1 minuto basta para todo."
        ],
        "correctIndex": 1,
        "rationale": "Sin agua potable, limitar operaciones o usar fuentes seguras verificadas."
      }
    ]
  },
  {
    "id": 3,
    "level": "Dif√≠cil",
    "color": "üî¥",
    "questions": [
      {
        "q": "Recepci√≥n: latas abolladas o hinchadas:",
        "options": [
          "Aceptar si el contenido huele bien.",
          "Rechazar por posible contaminaci√≥n/deterioro.",
          "Abrir y cocinar de inmediato."
        ],
        "correctIndex": 1,
        "rationale": "Envases alterados son criterio de rechazo por riesgo f√≠sico/qu√≠mico/biol√≥gico."
      },
      {
        "q": "Recalentar platos preparados de forma segura:",
        "options": [
          "Alcanzar 70 ¬∞C en el centro en menos de 1 hora con equipo adecuado.",
          "Cualquier temperatura si se mantiene al ba√±o mar√≠a.",
          "60 ¬∞C basta si la salsa hierve."
        ],
        "correctIndex": 0,
        "rationale": "Recalentamiento r√°pido hasta 70 ¬∞C; no usar equipos lentos como elevadores de temperatura."
      },
      {
        "q": "Riesgo de acrilamida/PAH:",
        "options": [
          "Asociado a cocciones muy tostadas/quemadas en alimentos ricos en almid√≥n.",
          "Solo en frituras de pescado.",
          "Sin relevancia sanitaria."
        ],
        "correctIndex": 0,
        "rationale": "Evita tonalidades muy oscuras en patatas, pan y rebozados."
      },
      {
        "q": "Clasificaci√≥n de peligro: fragmento de cristal en un plato:",
        "options": [
          "Qu√≠mico",
          "F√≠sico",
          "Biol√≥gico"
        ],
        "correctIndex": 1,
        "rationale": "Se trata de un peligro f√≠sico (cuerpo extra√±o)."
      },
      {
        "q": "Control de equipos de fr√≠o:",
        "options": [
          "Sobrecargar c√°maras para optimizar espacio.",
          "Registrar temperaturas y permitir circulaci√≥n de aire.",
          "Mantener puertas abiertas en preparaciones largas."
        ],
        "correctIndex": 1,
        "rationale": "No sobrecargar; registra temperaturas y deja espacio para el aire."
      },
      {
        "q": "Herida en la mano del manipulador/a:",
        "options": [
          "Trabajar normal si es peque√±a.",
          "Desinfectar, cubrir con ap√≥sito impermeable visible y usar guante; informar.",
          "Solo lavarse."
        ],
        "correctIndex": 1,
        "rationale": "Las heridas son foco de contaminaci√≥n; proteger y valorar aptitud."
      },
      {
        "q": "Separaci√≥n en almacenamiento (una c√°mara):",
        "options": [
          "Pescados crudos arriba.",
          "Cocinados arriba; crudos abajo; evitar cartones dentro.",
          "Verduras crudas sobre cocinados para frescor."
        ],
        "correctIndex": 1,
        "rationale": "Evita goteos de crudos sobre listos; reduce materiales porosos dentro de c√°mara."
      },
      {
        "q": "Enfriamiento r√°pido de platos cocinados:",
        "options": [
          "A ‚â§8 ¬∞C en <2 h; abatidor o porciones peque√±as.",
          "Esperar a ambiente hasta templado.",
          "Tapar caliente y guardar en c√°mara."
        ],
        "correctIndex": 0,
        "rationale": "Cruza la zona de peligro lo antes posible."
      },
      {
        "q": "Conductas personales adecuadas:",
        "options": [
          "Peinarse en cocina con cofia.",
          "Evitar tocarse la cara; toser/estornudar en pa√±uelo desechable y lavarse manos despu√©s.",
          "Usar el mismo pa√±o para manos y encimera."
        ],
        "correctIndex": 1,
        "rationale": "Minimiza transferencias de microorganismos."
      },
      {
        "q": "Descongelaci√≥n de mariscos grandes:",
        "options": [
          "En nevera sobre rejilla y bandeja para goteos; tiempo planificado.",
          "A temperatura ambiente por rapidez.",
          "Bajo agua caliente para acelerar."
        ],
        "correctIndex": 0,
        "rationale": "Evita zona de peligro y contaminaci√≥n de superficies."
      },
      {
        "q": "Gesti√≥n de al√©rgenos en cocina:",
        "options": [
          "Producir todos los platos en la misma zona.",
          "Separar preparaci√≥n, utensilios y almacenamiento; limpiar y etiquetar correctamente.",
          "Solo avisar verbalmente al cliente."
        ],
        "correctIndex": 1,
        "rationale": "La separaci√≥n f√≠sica/procedimental y limpieza evitan trazas accidentales."
      },
      {
        "q": "Pescado listo para consumo en c√°mara junto a carne cruda destapada:",
        "options": [
          "Aceptar si hay rejilla.",
          "Inaceptable: riesgo de goteo/olores y contaminaci√≥n cruzada.",
          "Da igual si se consume hoy."
        ],
        "correctIndex": 1,
        "rationale": "Los listos para consumo deben estar alejados de crudos y siempre protegidos."
      },
      {
        "q": "Higienizaci√≥n de cortadoras de fiambre:",
        "options": [
          "Diaria al final del turno.",
          "Tras cada cambio de producto y, como m√≠nimo, varias veces al d√≠a seg√∫n uso; desmontar piezas.",
          "Solo pasar un pa√±o h√∫medo."
        ],
        "correctIndex": 1,
        "rationale": "Desmontaje y desinfecci√≥n peri√≥dica previene biofilms."
      },
      {
        "q": "Huevos pasteurizados vs. frescos en elaboraciones crudas (mahonesa):",
        "options": [
          "Ambos equivalentes.",
          "Preferir pasteurizados para evitar Salmonella.",
          "Usar frescos si est√°n fr√≠os."
        ],
        "correctIndex": 1,
        "rationale": "Los pasteurizados reducen riesgo en salsas/cremas no sometidas a calor."
      },
      {
        "q": "Cuchillos con mango da√±ado:",
        "options": [
          "Pueden usarse si se desinfectan.",
          "Reemplazar; pueden albergar suciedad y desprender fragmentos.",
          "Cubrir con cinta."
        ],
        "correctIndex": 1,
        "rationale": "Riesgo f√≠sico y microbiol√≥gico por grietas y desprendimientos."
      },
      {
        "q": "Carnes marinadas para consumir poco hechas:",
        "options": [
          "El marinado elimina pat√≥genos.",
          "El marinado no sustituye la cocci√≥n a temperatura segura.",
          "Se pueden dejar a temperatura ambiente."
        ],
        "correctIndex": 1,
        "rationale": "Los √°cidos reducen carga pero no garantizan inocuidad; cocinar adecuadamente."
      },
      {
        "q": "Desinfectantes alimentarios:",
        "options": [
          "Usar cualquiera de uso dom√©stico.",
          "Usar productos autorizados, respetando concentraci√≥n y tiempo de contacto.",
          "Cuanto m√°s concentrado mejor."
        ],
        "correctIndex": 1,
        "rationale": "Seguir etiqueta garantiza eficacia sin residuos peligrosos."
      },
      {
        "q": "Recepci√≥n de pescado fresco:",
        "options": [
          "Olor fuerte a amon√≠aco es normal.",
          "Ojos brillantes, agallas rojas y olor marino suave.",
          "Puede venir parcialmente descongelado sin indicarlo."
        ],
        "correctIndex": 1,
        "rationale": "Los signos organol√©pticos indican frescura; la descongelaci√≥n debe declararse."
      },
      {
        "q": "Cocci√≥n de aves (aves enteras y piezas):",
        "options": [
          "60 ¬∞C en centro es suficiente.",
          "‚â•74‚Äì75 ¬∞C en el centro del producto.",
          "Depende del color del jugo."
        ],
        "correctIndex": 1,
        "rationale": "Las aves requieren temperaturas internas m√°s altas por riesgo de Salmonella/Campylobacter."
      },
      {
        "q": "Descongelaci√≥n en agua:",
        "options": [
          "Permitida sumergiendo en agua potable fr√≠a y protegida, cambiando agua; cocinar inmediatamente.",
          "Siempre prohibida.",
          "En agua caliente para acelerar."
        ],
        "correctIndex": 0,
        "rationale": "La t√©cnica puede usarse con control estricto y cocci√≥n inmediata."
      },
      {
        "q": "Productos qu√≠micos de limpieza:",
        "options": [
          "Pueden almacenarse junto a alimentos si est√°n cerrados.",
          "Separar en armario espec√≠fico se√±alizado; nunca sobre alimentos.",
          "Dejar envases sin etiqueta si se reconoce el contenido."
        ],
        "correctIndex": 1,
        "rationale": "Evita contaminaci√≥n qu√≠mica y confusiones; etiquetado obligatorio."
      },
      {
        "q": "Deshuesado de jam√≥n/queso en sala fr√≠a y corte en caliente:",
        "options": [
          "Admisible sin limpieza intermedia.",
          "Requiere limpieza/desinfecci√≥n y separaci√≥n de zonas/equipos o tiempos.",
          "No necesita control."
        ],
        "correctIndex": 1,
        "rationale": "Evita transporte de microorganismos entre zonas con distinta temperatura y riesgo."
      },
      {
        "q": "Uso de term√≥metros sonda:",
        "options": [
          "No es necesario si hay experiencia.",
          "Calibrar, limpiar y desinfectar la sonda antes/despu√©s; medir en el centro.",
          "Solo mirar el color del alimento."
        ],
        "correctIndex": 1,
        "rationale": "La medici√≥n objetiva asegura temperaturas de seguridad."
      },
      {
        "q": "Gesti√≥n de devoluciones/retiros por alerta alimentaria:",
        "options": [
          "No procede en hosteler√≠a.",
          "Tener procedimiento de trazabilidad inversa para localizar lotes y retirarlos.",
          "Informar solo si lo piden."
        ],
        "correctIndex": 1,
        "rationale": "Permite actuar con rapidez ante alertas para proteger a los clientes."
      },
      {
        "q": "Carne picada elaborada en local:",
        "options": [
          "Se puede guardar 48 h en fr√≠o.",
          "Consumir cuanto antes; si se conserva, ‚â§24 h a ‚â§4 ¬∞C y perfectamente identificada.",
          "Se puede mantener a 8‚Äì10 ¬∞C."
        ],
        "correctIndex": 1,
        "rationale": "Producto muy perecedero por su elevada superficie y manipulaci√≥n."
      }
    ]
  }
];

/* ==========================================================
   L√ìGICA DEL QUIZ
   ========================================================== */
const el = sel => document.querySelector(sel);
const screenStart = el('#screen-start');
const screenQuiz  = el('#screen-quiz');
const screenEnd   = el('#screen-end');
const picker      = el('#picker');
const chipLevel   = el('#chip-level');
const scoreMini   = el('#score-mini');
const totalMini   = el('#total-mini');
const bar         = el('#bar');
const qIdxEl      = el('#q-idx');
const qCountEl    = el('#q-count');
const qTitle      = el('#q-title');
const choicesBox  = el('#choices');
const explainBox  = el('#explain');
const btnNext     = el('#btn-next');
const btnNextBlock= el('#btn-next-block');
const btnRestart  = el('#btn-restart');
const endSub      = el('#end-sub');
const endSummary  = el('#end-summary');

let state = {
  blockIndex: 0,
  qIndex: 0,
  score: 0,
  locked: false,
};

function formatCount(n){ return n.toString().padStart(2,'0'); }

function renderPicker(){
  picker.innerHTML = '';
  blocks.forEach((b, i)=>{
    const div = document.createElement('button');
    div.type="button";
    div.className = 'block';
    div.innerHTML = `
      <div class="tag">Bloque ${b.id} ¬∑ ${b.level}</div>
      <div class="lv">${b.color} Nivel ${b.id}</div>
      <div class="desc">${b.questions.length || 0} preguntas cargadas ¬∑ objetivo 25</div>
      <span class="go">Empezar<span aria-hidden="true">‚ûú</span></span>
    `;
    div.addEventListener('click', ()=> startBlock(i));
    picker.appendChild(div);
  });
}
renderPicker();

function startBlock(i){
  state = { blockIndex:i, qIndex:0, score:0, locked:false };
  history.pushState({page:'quiz'}, '', '#quiz'); // Protege atr√°s
  screenStart.classList.add('hidden');
  screenEnd.classList.add('hidden');
  screenQuiz.classList.remove('hidden');
  chipLevel.textContent = `Bloque ${blocks[i].id} ¬∑ ${blocks[i].level}`;
  totalMini.textContent = blocks[i].questions.length;
  renderQuestion();
}

function renderQuestion(){
  const b = blocks[state.blockIndex];
  const total = b.questions.length;
  if(state.qIndex >= total){
    return endBlock();
  }
  const q = b.questions[state.qIndex];
  qIdxEl.textContent = `Pregunta ${formatCount(state.qIndex+1)}`;
  qCountEl.textContent = `/ ${formatCount(total)}`;
  qTitle.textContent = q.q;
  bar.style.width = `${((state.qIndex)/Math.max(total,1))*100}%`;
  scoreMini.textContent = state.score;
  choicesBox.innerHTML = '';
  explainBox.classList.add('hidden');
  explainBox.innerHTML = '';
  btnNext.disabled = true;
  state.locked = false;

  q.options.forEach((text, idx)=>{
    const c = document.createElement('div');
    c.className = 'choice';
    c.innerHTML = `
      <div class="bullet" aria-hidden="true"></div>
      <div>${text}</div>
    `;
    c.addEventListener('click', ()=> onSelect(idx));
    choicesBox.appendChild(c);
  });
}

function onSelect(idx){
  if(state.locked) return;
  state.locked = true;
  const b = blocks[state.blockIndex];
  const q = b.questions[state.qIndex];
  const nodes = [...choicesBox.children];
  nodes.forEach((node, i)=>{
    node.classList.add('selected');
    if(i === q.correctIndex){ node.classList.add('correct'); }
    if(i === idx && i !== q.correctIndex){ node.classList.add('incorrect'); }
  });
  if(idx === q.correctIndex){ state.score++; scoreMini.textContent = state.score; }

  explainBox.classList.remove('hidden');
  explainBox.innerHTML = `
    <div><b>Respuesta correcta:</b> ${q.options[q.correctIndex]}</div>
    <div class="muted" style="margin-top:6px">${q.rationale}</div>
  `;
  btnNext.disabled = false;
}

btnNext.addEventListener('click', ()=>{
  state.qIndex++;
  renderQuestion();
});

function endBlock(){
  screenQuiz.classList.add('hidden');
  screenEnd.classList.remove('hidden');
  const b = blocks[state.blockIndex];
  const total = b.questions.length;
  bar.style.width = '100%';
  const pct = Math.round((state.score/Math.max(total,1))*100);
  endSub.textContent = `Bloque ${b.id} ¬∑ ${b.level} ‚Äî ${state.score}/${total} correctas (${pct}%).`;

  endSummary.innerHTML = `
    <div class="pill ok">‚úÖ Aciertos: <b>${state.score}</b></div>
    <div class="pill bad">‚ùå Errores: <b>${total - state.score}</b></div>
    <div class="pill warn">üìä Puntuaci√≥n: <b>${pct}%</b></div>
  `;

  const nextBlock = state.blockIndex + 1;
  btnNextBlock.textContent = nextBlock < blocks.length ? `Siguiente bloque (Nivel ${nextBlock+1})` : 'Finalizar';
  btnNextBlock.onclick = ()=>{
    if(nextBlock < blocks.length){
      startBlock(nextBlock);
    } else {
      restartAll();
    }
  };
}

btnRestart.addEventListener('click', restartAll);

function restartAll(){
  history.pushState({page:'start'}, '', '#');
  screenEnd.classList.add('hidden');
  screenQuiz.classList.add('hidden');
  screenStart.classList.remove('hidden');
  renderPicker();
}

/* Bloqueo de retroceso del historial dentro del quiz */
window.addEventListener('popstate', (e)=>{
  if(!screenStart.classList.contains('hidden') && window.location.hash !== '#quiz') return;
  if(window.location.hash === '#quiz'){
    history.pushState({page:'quiz'}, '', '#quiz');
  } else {
    restartAll();
  }
});

history.replaceState({page:'start'}, '', '#');



// ================== RANKING (localStorage) ==================
const LS_KEY = "quizLeaderboard_v1";
const NAME_KEY = "quizPlayerName";

const screenLB = document.querySelector('#screen-lb');
const lbBox = document.querySelector('#leaderboard');
const btnSaveName = document.querySelector('#btn-save-name');
const playerNameInput = document.querySelector('#player-name');
const btnViewLB = document.querySelector('#btn-view-lb');
const btnBackStart = document.querySelector('#btn-back-start');
const btnClearLB = document.querySelector('#btn-clear-lb');
const btnSaveRank = document.querySelector('#btn-save-rank');
const rankNameInput = document.querySelector('#rank-name');

function getLeaderboard(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; }catch(e){ return []; }
}
function setLeaderboard(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}
function getPlayerName(){
  return localStorage.getItem(NAME_KEY) || sessionStorage.getItem(NAME_KEY) || "";
}
function setPlayerName(name){
  localStorage.setItem(NAME_KEY, name);
  sessionStorage.setItem(NAME_KEY, name);
}

function renderLeaderboard(){
  const data = getLeaderboard();
  if(!data.length){
    lbBox.innerHTML = '<p class="muted">A√∫n no hay puntuaciones guardadas.</p>';
    return;
  }
  // Keep last attempt per name (by date), then sort by pct desc, then date desc
  const lastByName = {};
  data.sort((a,b)=> new Date(a.date)-new Date(b.date)).forEach(item=> lastByName[item.name]=item);
  const arr = Object.values(lastByName).sort((a,b)=>{
    if(b.pct !== a.pct) return b.pct - a.pct;
    return new Date(b.date) - new Date(a.date);
  }).slice(0,20);
  let rows = arr.map((it, i)=>{
    const cls = i===0?'rank1':(i===1?'rank2':(i===2?'rank3':''));
    return `<tr class="${cls}"><td>${i+1}</td><td>${it.name}</td><td>Bloque ${it.blockId}</td><td>${it.score}/${it.total}</td><td>${it.pct}%</td><td>${new Date(it.date).toLocaleString()}</td></tr>`;
  }).join("");
  lbBox.innerHTML = `<table class="table"><thead><tr><th>#</th><th>Nombre</th><th>Bloque</th><th>Puntuaci√≥n</th><th>%</th><th>Fecha</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function showLeaderboard(){
  screenStart.classList.add('hidden');
  screenQuiz.classList.add('hidden');
  screenEnd.classList.add('hidden');
  screenLB.classList.remove('hidden');
  renderLeaderboard();
  history.pushState({page:'lb'}, '', '#ranking');
}

btnViewLB?.addEventListener('click', showLeaderboard);
btnBackStart?.addEventListener('click', ()=>{
  screenLB.classList.add('hidden');
  screenStart.classList.remove('hidden');
  history.pushState({page:'start'}, '', '#');
});

btnSaveName?.addEventListener('click', ()=>{
  const n = playerNameInput.value.trim();
  if(!n){ alert('Escribe tu nombre para guardarlo.'); return; }
  setPlayerName(n);
  alert('Nombre guardado para el ranking.');
});

btnClearLB?.addEventListener('click', ()=>{
  const name = getPlayerName();
  if(!name){ alert('Guarda tu nombre primero.'); return; }
  const data = getLeaderboard().filter(x => x.name !== name);
  setLeaderboard(data);
  alert('Puntuaciones de tu nombre eliminadas del ranking local.');
});

// Prefill name boxes
window.addEventListener('load', ()=>{
  const n = getPlayerName();
  if(n){
    if(playerNameInput) playerNameInput.value = n;
    if(rankNameInput) rankNameInput.value = n;
  }
});

// Override startBlock to require/remember name (optional, but we warn if missing)
const _startBlock = startBlock;
startBlock = function(i){
  const n = getPlayerName() || (playerNameInput?.value.trim() || '');
  if(n){ setPlayerName(n); }
  else{
    if(!confirm('No has indicado nombre. Puedes jugar sin ranking o volver atr√°s para escribirlo. ¬øContinuar sin nombre?')){ return; }
  }
  _startBlock(i);
}

// On end screen, allow saving to leaderboard
btnSaveRank?.addEventListener('click', ()=>{
  const name = (rankNameInput?.value || '').trim() || getPlayerName();
  if(!name){ alert('Indica un nombre para guardar tu puntuaci√≥n.'); return; }
  const b = blocks[state.blockIndex];
  const total = b.questions.length;
  const pct = Math.round((state.score/Math.max(total,1))*100);
  const entry = {
    name, blockId: b.id, score: state.score, total, pct, date: new Date().toISOString()
  };
  const data = getLeaderboard();
  data.push(entry);
  setLeaderboard(data);
  setPlayerName(name);
  alert('¬°Puntuaci√≥n guardada en el ranking local!');
  renderLeaderboard();
});

// Hook popstate to handle #ranking
const _popHandler = window.onpopstate;
window.addEventListener('popstate', ()=>{
  if(location.hash === '#ranking'){
    showLeaderboard();
  }
});



// ====== TRACK ANSWERS FOR REVIEW ======
if(!state) var state = {};
state.answers = [];

const bannerBox = document.createElement('div'); // dynamic banner per question
bannerBox.className = 'banner hidden';
document.querySelector('#screen-quiz .footer').insertAdjacentElement('beforebegin', bannerBox);

const reviewList = document.querySelector('#review-list');
const adviceBody = document.querySelector('#advice-body');

function resetBanner(){ bannerBox.className = 'banner hidden'; bannerBox.innerHTML=''; }

function onSelect_withReview(idx){
  if(state.locked) return;
  state.locked = true;
  const b = blocks[state.blockIndex];
  const q = b.questions[state.qIndex];
  const nodes = [...choicesBox.children];
  nodes.forEach((node, i)=>{
    node.classList.add('selected');
    if(i === q.correctIndex){ node.classList.add('correct'); }
    if(i === idx && i !== q.correctIndex){ node.classList.add('incorrect'); }
  });
  const ok = idx === q.correctIndex;
  if(ok){ state.score++; scoreMini.textContent = state.score; }

  // Save answer for later review
  state.answers[state.qIndex] = {
    q: q.q,
    selectedIndex: idx,
    selectedText: q.options[idx],
    correctIndex: q.correctIndex,
    correctText: q.options[q.correctIndex],
    rationale: q.rationale,
    isCorrect: ok
  };

  // Show banner + explanation
  explainBox.classList.remove('hidden');
  explainBox.innerHTML = `
    <div><b>Respuesta correcta:</b> ${q.options[q.correctIndex]}</div>
    <div class="muted" style="margin-top:6px">${q.rationale}</div>
  `;
  bannerBox.classList.remove('hidden');
  bannerBox.classList.add(ok ? 'ok' : 'bad');
  bannerBox.innerHTML = ok
    ? '‚úÖ <b>¬°Correcto!</b> Buen trabajo.'
    : '‚ùå <b>Respuesta incorrecta.</b> Revisa la explicaci√≥n y contin√∫a.';

  btnNext.disabled = false;
}

// Override original onSelect
onSelect = onSelect_withReview;

// ====== SUMMARY & RECOMMENDATIONS AT END ======
function buildSummaryAndAdvice(){
  // Build incorrect list
  const wrong = (state.answers || []).filter(a => a && !a.isCorrect);
  if(!wrong.length){
    reviewList.innerHTML = '<p class="muted">üéâ ¬°No hay preguntas falladas en este bloque!</p>';
  }else{
    reviewList.innerHTML = wrong.map(a => `
      <div class="review-item">
        <div class="q">‚Ä¢ ${a.q}</div>
        <div class="u">Tu respuesta: ${a.selectedText} ‚ùå</div>
        <div class="c">Correcta: ${a.correctText} ‚úÖ</div>
        <div class="muted small">${a.rationale}</div>
      </div>
    `).join("");
  }

  // Simple topic-based advice from keywords
  const topics = [
    {key:'temperatura', label:'Control de temperaturas', tip:'Refuerza rangos clave: 0‚Äì4 ¬∞C (fr√≠o), ‚â•65 ¬∞C (mantenimiento caliente), 70‚Äì75 ¬∞C (cocciones/recalentado), ‚Äì20 ¬∞C ‚â•24 h (anisakis). Usa term√≥metro sonda y registros.'},
    {key:'descongel', label:'Descongelaci√≥n segura', tip:'Planifica descongelaciones en refrigeraci√≥n o microondas (cocci√≥n inmediata). Evita temperatura ambiente. Recoge goteos en bandeja.'},
    {key:'al√©rgen', label:'Gesti√≥n de al√©rgenos', tip:'Separa zonas/utensilios, etiqueta y comunica por escrito los al√©rgenos. Evita trazas con limpieza efectiva entre tareas.'},
    {key:'limpieza', label:'Limpieza y desinfecci√≥n', tip:'Secuencia correcta: limpiar primero (detergente) y luego desinfectar. Registra PLD y respeta tiempos/concentraciones.'},
    {key:'aceite', label:'Frituras/aceites', tip:'Renueva con signos de humo, oscurecimiento, viscosidad o espuma. Evita sobre-tostados que generan acrilamida.'},
    {key:'almacen', label:'Almacenamiento y orden', tip:'Cocinados arriba; crudos abajo. FIFO/FEFO, separaci√≥n de qu√≠micos, no sobrecargar c√°maras; deja circular el aire fr√≠o.'},
    {key:'higiene', label:'Higiene personal y manos', tip:'L√°vate antes de manipular y al cambiar de tarea; heridas cubiertas con ap√≥sito impermeable + guante; nada de m√≥viles/joyas.'},
    {key:'trazabil', label:'Trazabilidad y recepci√≥n', tip:'Conserva albaranes/etiquetas, verifica temperaturas de entrega y estado de envases; rechaza anomal√≠as (latas abolladas/hinchadas).'}
  ];

  // Count misses per topic
  const counters = topics.map(t => ({label:t.label, tip:t.tip, count:0}));
  wrong.forEach(a => {
    const text = (a.q + ' ' + a.rationale).toLowerCase();
    topics.forEach((t, idx)=>{
      if(text.includes(t.key)) counters[idx].count += 1;
    });
  });
  counters.sort((a,b)=> b.count - a.count);
  const focus = counters.filter(c=>c.count>0).slice(0,2);

  if(focus.length){
    adviceBody.innerHTML = '<ul>' + focus.map(c=>`<li><b>${c.label}:</b> ${c.tip}</li>`).join('') + '</ul>';
  }else{
    adviceBody.innerHTML = '<p class="muted">Buen desempe√±o general. Repite el bloque o prueba un nivel superior para consolidar.</p>';
  }
}

const _endBlock2 = endBlock;
endBlock = function(){
  _endBlock2();
  buildSummaryAndAdvice();
  resetBanner();
}



// ===== GitHub sync config =====
const GHSYNC = {
  ENABLED: true,
  ENDPOINT_URL: "https://your-worker.example.workers.dev/submit", // <-- cambia a tu URL del Worker
  // Campos adicionales de contexto de tu hotel (metadatos):
  hotel: {
    brand: "Sercotel Guadiana / Cumbria",
    propertyCodes: ["GUADIANA","CUMBRIA"],
    project: "Formaci√≥n Manipulaci√≥n de Alimentos",
    version: "1.0.0"
  }
};

async function sendToGitHub(entry){
  try{
    if(!GHSYNC.ENABLED) return {ok:false, reason:"disabled"};
    const res = await fetch(GHSYNC.ENDPOINT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(entry),
    });
    if(!res.ok){
      throw new Error("HTTP "+res.status);
    }
    const data = await res.json().catch(()=>({ok:true}));
    return {ok:true, data};
  }catch(e){
    console.warn("GitHub sync failed:", e);
    return {ok:false, error: String(e)};
  }
}

// Cola local si no hay red
function enqueuePending(entry){
  const k = "quizPendingSends_v1";
  const arr = JSON.parse(localStorage.getItem(k)||"[]");
  arr.push(entry);
  localStorage.setItem(k, JSON.stringify(arr));
}
async function flushPending(){
  const k = "quizPendingSends_v1";
  let arr = JSON.parse(localStorage.getItem(k)||"[]");
  if(!arr.length) return;
  const still = [];
  for(const e of arr){
    const r = await sendToGitHub(e);
    if(!r.ok) still.push(e);
  }
  localStorage.setItem(k, JSON.stringify(still));
}
window.addEventListener('online', flushPending);
setTimeout(flushPending, 3000);

// Hook guardado en ranking para tambi√©n enviar a GitHub
const _saveRank = btnSaveRank?.onclick;
btnSaveRank?.addEventListener('click', async ()=>{
  try{
    const b = blocks[state.blockIndex];
    const total = b.questions.length;
    const pct = Math.round((state.score/Math.max(total,1))*100);
    const name = (rankNameInput?.value || '').trim() || getPlayerName() || "anon";
    const wrong = (state.answers || []).filter(a => a && !a.isCorrect).map(a => ({
      q: a.q, selected: a.selectedText, correct: a.correctText
    }));
    const payload = {
      name, blockId: b.id, level: b.level,
      score: state.score, total, pct,
      date: new Date().toISOString(),
      wrong, // listado resumido
      meta: GHSYNC.hotel,
      ua: navigator.userAgent || "",
    };
    const r = await sendToGitHub(payload);
    if(!r.ok) enqueuePending(payload);
  }catch(e){
    console.warn("enqueue on error", e);
  }
});
</script>
</body>
</html>
